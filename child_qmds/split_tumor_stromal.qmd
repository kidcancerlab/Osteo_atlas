Label potential tumor cell and then split the seurat object into cancer cells and
normal cells. The silhouette score was used to cluster the normal cells and 0.1
resolution was used to cluster the cancer cells (to reduce the excessive)
clustering.
It might be a worthwile to annotate or re run SCEVAN in the cancer cells to filter
out any normal cells that might have been group as cancer cells.

## Pull in cancer cell annotation from all the methods we attempted
Put all the labels into the metadata so we can use them to label the cells
We will make these column names have the format "cancer_lable_{method_name}" so we can select them easily for plotting and doing an ensemble labeling

```{r}
#| fig.align: center
#| echo: FALSE
#| eval: FALSE

#parallel::mclapply(unique(all_samples_csv$unique), function(group)
for (group in c("patient_prim", "patient_mets", "mm_prim", "mm_mets")) {
    object <-
        qs::qread(str_c("output/seurat_objects/harmony_sobjs_annot/",
                        group,
                        ".qs"))

    # Pull in cancer cell annotation from all the methods we attempted and add them to the metadata
    for (method_used in c("SCEVAN", "scATOMIC", "celltype", "snv_calling")) {
        cancer_label_file <- str_c("output/id_tumor/",
                       method_used,
                       "/",
                       group,
                       "_metadata.tsv")

        if (file.exists(cancer_label_file)) {
            cancer_label <- readr::read_tsv(cancer_label_file) %>%
                filter(cell %in% colnames(object)) %>%
                column_to_rownames("cell")
        }
        object <- object %>%
            AddMetaData(metadata = cancer_label)
    }

    #save the seurat object.size
    qs::qsave(object, str_c("output/seurat_objects/final_combined_sobjs/",
                            group,
                            ".qs"))

    #plot for the cancer normal cells, mouse do not have scatomic tumor call
    if ("scatomic_tumor_call" %in% colnames(object@meta.data)){
        combinedplot1 <-
            dimplot_better(object,
                           group_by = "scatomic_tumor_call") +
                NoLegend() +
                theme(plot.title = element_text(size = 7))
    } else {
        combinedplot1 <- ggplot(data = NULL) +
                            aes(x = as.factor(1), y = as.factor(1)) +
                            geom_text(aes(label = str_c("scatomic_tumor_call not present for ", group)))
    }
    combineplot2 <-
        dimplot_better(object,
                       group_by = "scevan_tumor_call") +
            NoLegend() +
            theme(plot.title = element_text(size = 7))
    combineplot3 <-
        dimplot_better(object,
                       group_by = "final_snv_call") +
            NoLegend() +
            theme(plot.title = element_text(size = 7))
    combineplot4 <-
        dimplot_better(object,
                       group_by = "celltype_tumor_call") +
            NoLegend() +
            theme(plot.title = element_text(size = 7))
    combineplot5 <-
        dimplot_better(object,
                       group_by = "new_annot_clust") +
            NoLegend() +
            theme(plot.title = element_text(size = 7))
    combineplot6 <-
        dimplot_better(object,
                       group_by = "sample_name") +
            NoLegend() +
            theme(plot.title = element_text(size = 7))

    # use patchwork to combine the plots
    combined_plots <- 
        patchwork::wrap_plots(combinedplot1,
                            combineplot2,
                            combineplot3,
                            combineplot4,
                            combineplot5,
                            combineplot6,
                            ncol = 3,
                            widths = 21,
                            heights = 14) +
            patchwork::plot_annotation(title = group) +
            theme(plot.title = element_text(size = 10))

    #save the combined plots
    ggsave(str_c("output/figures/combined_plots/",
                 group,
                 "/",
                 "combined_plots.png"),
           plot = combined_plots,
           width = 21,
           height = 14)

    # save the plot as qs object
    qs::qsave(combined_plots,
              str_c("output/figures/combined_plots/",
                    group,
                    "/",
                    "combined_plots.qs"))
}

#make feature plots for all the groups
for (group in c("patient_prim", "patient_mets", "mm_prim", "mm_mets")) {
    object <-
        qs::qread(str_c("output/seurat_objects/final_combined_sobjs/",
                        group,
                        ".qs"))
    # plot feature plots
    if (object$organism[1] == "human") {
        # tumor features for human
        featureplot1_tumor <-
            FeaturePlot(object,
                        features = c("COL1A1", "COL1A2", "FBLN1",
                                     "SATB2", "RUNX2", "SOX9"),
                        ncol = 3)
        # Tcell=CD3E, Neutrophil=CD4, Macrophase=CD68,CD14, Bcells=MS4A1 or CD20, Endotthelial=ESAM, Epithelial=MUC1
        featureplot2_immune <-
            FeaturePlot(object,
                        features = c("CD3E", "CD4", "CD68",
                                     "MUC1", "MS4A1", "ESAM"),
                        ncol = 3)
    } else {
        # plots for mouse
        featureplot1_tumor <-
            FeaturePlot(object,
                        features = c("Col1a1", "Col1a2", "Fbln1",
                                     "Satb2", "Runx2", "Sox9"),
                        ncol = 3) 

        featureplot2_immune <-
            FeaturePlot(object,
                        features = c("Cd3e", "Cd4", "Cd68",
                                     "Muc1", "Ms4a1", "Esam"),
                        ncol = 3) 
    }
    ggsave(str_c("output/figures/combined_plots/",
                 group,
                 "/",
                 "tumor_featureplots.png"),
           plot = featureplot1_tumor,
           width = 21,
           height = 14)

    qs::qsave(featureplot1_tumor,
              str_c("output/figures/combined_plots/",
                    group,
                    "/",
                    "tumor_featureplots.qs"))

    ggsave(str_c("output/figures/combined_plots/",
                 group,
                 "/",
                 "immune_featureplots.png"),
           plot = featureplot2_immune,
           width = 21,
           height = 14)

    qs::qsave(featureplot2_immune,
              str_c("output/figures/combined_plots/",
                    group,
                    "/",
                    "immune_featureplots.qs"))
}
```


## Split by clustering with right resolution as found by clustree

```{r}
# Harmony parameters for the split

harmony_params <-
    list(patient_prim = list(group_by = c("sample_name",
                                          "method",
                                          "data_source"),
                             theta = c(5, 5, 5),
                             lambda = c(0.5, 0.5, 0.5)),
        patient_mets = list(group_by = c("sample_name",
                                         "method",
                                         "data_source"),
                            theta = c(7, 7, 7),
                            lambda = c(0.5, 0.5, 0.5)),
        xeno_prim_human = list(group_by = c("sample_name",
                                            "method",
                                            "data_source"),
                               theta = c(7, 7, 7)),
        xeno_mets_human = list(group_by = c("sample_name",
                                            "method",
                                            "data_source"),
                               theta = c(7, 7, 7)),
        xeno_prim_mouse = list(group_by = c("sample_name",
                                            "data_source"),
                                theta = c(7, 7)),
        xeno_mets_mouse = list(group_by = c("sample_name",
                                            "method",
                                            "data_source"),
                               theta = c(7, 7, 7)),
        mm_prim = list(group_by = c("sample_name",
                                    "model"),
                       theta = c(12, 12),
                       lambda = c(0.1, 0.1)),
        mm_mets = list(group_by = c("sample_name",
                                    "model"),
                       theta = c(7, 7),
                       lambda = c(0.1, 0.1)),
        normal_bone = list(group_by = c("sample_name"),
                           theta = c(7)))


#reference for annotating mets
human_lung_ref <-
    qs::qread("input/downloads/ds_human_lung_atlas.qs") %>%
    subset(free_annotation != "Lymphatic_EC_differentiating")

mets_ref <- list(GetAssayData(human_lung_ref), hpca)
mets_label <- list(human_lung_ref$free_annotation, hpca$label.fine)

mouse_lung_ref_new <- qs::qread("input/downloads/normal_mouselung.qs")

mouse_lung_ref_new$CellType <-
            str_replace_all(mouse_lung_ref_new$free_annotation,
                            c("/" = "_",
                              "\\+" = "_plus",
                              "-" = "_",
                              " " = "_",
                              "^Alveolar_Epithelial_Type_2$" = "Alveolar_Epithelial"))


for (group in c("patient_prim", "patient_mets", "mm_prim", "mm_mets")) {
    object <-
        qs::qread(str_c("output/seurat_objects/final_combined_sobjs/",
                        group,
                        ".qs"))

    if (any(c("S0200", "S0201") %in% object$sample_name)) {
        object <- subset(object,
                         sample_name != "S0200" & sample_name != "S0201")
    }

    for (cell_group_name in c("cancer_cells", "normal_cells")) {
        sub_group <- str_c(group, "_", cell_group_name)

        if  (cell_group_name == "normal_cells") {
            s_obj <-
                subset(x = object,
                        celltype_tumor_call == cell_group_name) %>%
                process_seurat() %>%
                RunHarmony(group.by.vars = harmony_params[[group]]$group_by) %>%
                process_seurat(reduction = "harmony")

            if (sub_group == "patient_mets_normal_cells") {
                ref_lung <- 
                    SingleR::SingleR(test = as.SingleCellExperiment(s_obj),
                                    ref = GetAssayData(human_lung_ref),
                                    labels = human_lung_ref$free_annotation,
                                    aggr.ref = TRUE)
            } else if (sub_group == "patient_prim_normal_cells") {
                ref_lung <- 
                    SingleR::SingleR(test = as.SingleCellExperiment(s_obj),
                                    ref = list(hpca, huim),
                                    labels = list(hpca$label.fine, huim$label.fine),
                                    aggr.ref = TRUE)
            } else if (sub_group == "mm_mets_normal_cells") {
                ref_lung <- 
                    SingleR::SingleR(test = as.SingleCellExperiment(s_obj),
                                    ref = GetAssayData(mouse_lung_ref_new),
                                    labels = mouse_lung_ref_new$CellType,
                                    aggr.ref = TRUE)
            } else {
                ref_lung <- 
                    SingleR::SingleR(test = as.SingleCellExperiment(s_obj),
                                    ref = list(moim, mord),
                                    labels = list(moim$label.fine, mord$label.fine),
                                    aggr.ref = TRUE)
            }
            s_obj$annotations <- ref_lung$labels

            Idents(s_obj) <- s_obj$seurat_clusters
            clust_info <- tibble()
            for (cluster in unique(s_obj$seurat_clusters)) {
                subset_object <- subset(s_obj, ident = cluster) %>%
                    FindVariableFeatures() %>%
                    ScaleData() %>%
                    # don't ask for more PCs than there are cells
                    RunPCA(npcs = min(50,
                                    sum(s_obj$seurat_clusters == cluster) - 1))

                if (length(unique(subset_object$sample_name)) > 1 &&
                    ncol(subset_object) > 50) {
                    subset_object <- RunHarmony(subset_object,
                                                group.by.vars = "sample_name") %>%
                        process_seurat(reduction = "harmony")
                } else {
                    subset_object <- subset_object
                }

                subset_object$re_cluster <- str_c(cluster,
                                                ".",
                                                subset_object$seurat_clusters)

                print(str_c("Done reclustering ", group, " ", cluster))
                clust_info <- subset_object@meta.data %>%
                        as.data.frame() %>%
                        select(re_cluster) %>%
                        rbind(clust_info)
            }

            s_obj <- AddMetaData(s_obj, metadata = clust_info)
            s_obj$new_annot_clust <- s_obj$re_cluster

            cluster_celltypes <-
                table(s_obj$re_cluster, s_obj$annotations) %>%
                as.data.frame() %>%
                group_by(Var1) %>%
                arrange(desc(Freq), .by_group = TRUE) %>%
                slice_head(n = 1)

            for (i in seq_len(nrow(cluster_celltypes))) {
                seurat_clust <- str_c("^", cluster_celltypes$Var1[i], "$") %>%
                    as.character()

                celltype <- cluster_celltypes$Var2[i] %>%
                    as.character()

                s_obj$new_annot_clust <-
                    str_replace_all(string = s_obj$new_annot_clust,
                                    pattern = seurat_clust,
                                    replacement = celltype)
            }
        } else {
            s_obj <-
                subset(x = object,
                        celltype_tumor_call == cell_group_name) %>% 
                process_seurat() %>%
                RunHarmony(group.by.vars = harmony_params[[group]]$group_by,
                            theta = harmony_params[[group]]$theta,
                            lambda = harmony_params[[group]]$lambda) %>%
                process_seurat(reduction = "harmony")
        }
        s_obj$Ann_level3 <-
            stringr::str_replace_all(s_obj$new_annot_clust,
                c("^DC__DC_$" = "Dendritic_cells",
                    "^DC__DC_103_11B_plus24_plus_$" = "Dendritic_cells",
                    "^DC__DC_PDC_8_plus_$" = "Plasmacytoid_Dendritic",
                    "^DC__DC_8_4_11B_plus_$" = "Dendritic_cells",
                    "^B_cell_Plasma_cell$" = "Plasma_Bcells",
                    "^Macrophages__MF_103_11B_plus24__$" = "Macrophages",
                    "^Macrophages__MF_11C_11B_plus_$" = "Macrophages",
                    "^DC_monocyte_derived_AEC_conditioned$" = "DC_monocyte_derived",
                    "^Mast_cells__MC.ES_$" = "Mast_cells",
                    "^Neutrophils__GN.Thio_$" = "Neutrophils",
                    "^Stromal_cells__ST.31_38_44__$" = "Stromal_cells",
                    "^T_cells__T.Tregs_$" = "Regulatory_T",
                    "^CD4_plus_T$" = "CD4T_cells",
                    "^CD8_plus_T$" = "CD8T_cells",
                    "^Capillary_Aerocyte$" = "EC_capillary_aerocyte",
                    "^Capillary$" = "EC_capillary",
                    "^Lympatic$" = "EC_Lympatic",
                    "^Myeloid_Dendritic_Type_1$" = "Myeloid_Dendritic",
                    "^Myofibroblast$" = "Myofibroblasts",
                    "^Natural_Killer$" = "NK_cells",
                    "^Plasma$" = "Plasma_Bcells",
                    "^B_cell_Plasma_cell$" = "Plasma_Bcells",
                    "^B$" = "B_cells",
                    "^Ciliated$" = "Ciliated_cells",
                    "^DC_monocyte_derived_AEC_conditioned$" = "DC_monocyte_derived",
                    "^DC_monocyte_derived_antiCD40_VAF347$" = "DC_monocyte_derived",
                    "^DC_monocyte_derived_mature$" = "DC_monocyte_derived",
                    "^Effector memory CD8 T cells$" = "Effector_memory_CD8T",
                    "^Endothelial_cells_blood_vessel" = "EC_blood_vessel",
                    "^Endothelial_cells_HUVEC_VEGF$" = "EC_HUVEC_VEGF",
                    "^Endothelial_cells_lymphatic$" = "EC_lymphatic",
                    "^Endothelial_cells_lymphatic_KSHV$" = "EC_lymphatic",
                    "^Fibroblasts_breast$" = "Fibroblasts",
                    "^Intermediate monocytes$" = "Intermediate_monocytes",
                    "^Low-density basophils$" = "Basophils",
                    "^Low-density neutrophils$" = "Neutrophils",
                    "^Macrophage_monocyte_derived_IL_4_Dex_TGFb$" = "Macrophage_monocyte_derived",
                    "^Macrophage_monocyte_derived_M_CSF$" = "Macrophage_monocyte_derived",
                    "^MAIT cells$" = "MAI_Tcells",
                    "^Monocyte_CD16_$" = "Monocytes_CD16_minus",
                    "^Monocyte_S._typhimurium_flagellin$" = "Monocytes",
                    "^Neutrophil_commensal_E._coli_MG1655$" = "Neutrophils",
                    "^Myeloid dendritic cells$" = "Myeloid_Dendritic",
                    "^Naive B cells$" = "Naive_Bcells",
                    "^Naive CD8 T cells$" = "Naive_CD8T",
                    "^NK_cell$" = "NK_cells",
                    "^Plasmablasts$" = "Plasma_Bcells",
                    "^Plasmacytoid dendritic cells$" = "Plasmacytoid_Dendritic",
                    "^Switched memory B cells$" = "Memory_Bcells",
                    "^T regulatory cells$" = "Regulatory_T",
                    "^T_cell_CD4_plus_central_memory$" = "Central_memory_CD4T",
                    "^T_cell_CD4_plus_effector_memory$" = "Effector_memory_CD4T",
                    "^T_cell_CD4_plus_Naive$" = "Naive_CD4T",
                    "^T_cell_CD8_plus_Central_memory$" = "Central_memory_CD8T",
                    "^T_cell_CD8_plus_naive$" = "Naive_CD8T",
                    "^T_cell_gamma_delta$" = "GammaDelta_Tcells",
                    "^AT1$" = "AlvEpithelial_T1",
                    "^AT2$" = "AlvEpithelial_T2",
                    "^CD4_T_cells$" = "CD4T_cells",
                    "^CD8_T_cells$" = "CD8T_cells",
                    "^DC1$" = "Dendritic_cells1",
                    "^DC2$" = "Dendritic_cells2",
                    "^EC_arterial$" = "EC_artery",
                    "^EC_general_capillary$" = "EC_capillary",
                    "^EC_venous_pulmonary$" = "EC_vein",
                    "^EC_venous_systemic$" = "EC_vein",
                    "^Lymphatic_EC_mature$" = "EC_lymphatic",
                    "^Multiciliated$" = "Ciliated_cells",
                    "^Non_classical_monocytes$" = "Nonclassical_monocytes",
                    "^Nonclassical_Monocyte$" = "Nonclassical_monocytes",
                    "^Classical_Monocyte$" = "Classical_monocytes",
                    "^Plasma_cells$" = "Plasma_Bcells",
                    "^Plasmacytoid_DCs$" = "Plasmacytoid_Dendritic",
                    "^T_cells_proliferating$" = "Proliferating_T",
                    "^Neutrophil$" = "Neutrophils",
                    "^Pericyte$" = "Pericytes",
                    "^Astrocytes$" = "Neurons",
                    "^Stem_cells$" = "Progenitors",
                    "^Basophil_Mast" = "Basophils",
                    "^Capillary_cells$" = "EC_capillary",
                    "^Artery_cells$" = "EC_artery",
                    "^Monocyte_leukotriene_D4$" = "Monocytes",
                    "^Vein_cells$" = "EC_vein",
                    "^Lymph_cells$" = "EC_lymphatic",
                    "^Alv_Macrophages$" = "Alveolar_macrophages",
                    "^Int_Macrophages$" = "Interstitial_macrophage",
                    "^Myo_Fibroblasts$" = "Myofibroblasts",
                    "^Oligodendrocytes$" = "Stromal_cells",
                    "^Transitional_Club_AT2$" = "Club_cells"))

        s_obj$Ann_level2 <-
            stringr::str_replace_all(s_obj$Ann_level3,
                    c("^Fibroblasts_activated$" = "Fibroblasts",
                        "^Fibroblasts_senescent$" = "Fibroblasts",
                        "^Macrophages_activated$" = "Macrophages",
                        "^Plasmacytoid_Dendritic$" = "Dendritic_cells",
                        "^Regulatory_T$" = "T_cells",
                        "^Alox5_plus_Lymphocytes$" = "Lymphocytes",
                        "^Alveolar_Epithelial$" = "Epithelial_cells",
                        "^Alveolar_Fibroblast$" = "Fibroblasts",
                        "^Alveolar_Macrophage$" = "Macrophages",
                        "^Ccr7_plus_Dendritic$" = "Dendritic_cells",
                        "^Ciliated_cells$" = "Epithelial_cells",
                        "^Classical_monocytes" = "Monocytes",
                        "^EC_capillary$" = "Endothelial_cells",
                        "^EC_capillary_aerocyte$" = "Endothelial_cells",
                        "^EC_Lympatic$" = "Endothelial_cells",
                        "^Interstitial_Macrophage$" = "Macrophages",
                        "^Interstital_macrophage$" = "Macrophages",
                        "^Myeloid_Dendritic$" = "Dendritic_cells",
                        "^Myofibroblasts$" = "Fibroblasts",
                        "^Nonclassical_monocytes$" = "Monocytes",
                        "^Plasma_Bcells$" = "B_cells",
                        "^Proliferating_Alveolar_Macrophage" = "Macrophages",
                        "^Proliferating_T$" = "T_cells",
                        "^Proliferating_Dendritic$" = "Dendritic_cells",
                        "^Zbtb32_plus_B$" = "B_cells",
                        "^Central_memory_CD4T$" = "T_cells",
                        "^Central_memory_CD8T$" = "T_cells",
                        "^DC_monocyte_derived$" = "Dendritic_cells",
                        "^EC_blood_vessel$" = "Endothelial_cells",
                        "^EC_HUVEC_VEGF$" = "Endothelial_cells",
                        "^Effector_memory_CD4T$" = "T_cells",
                        "^Effector_memory_CD8T$" = "T_cells",
                        "^GammaDelta_Tcells$" = "T_cells",
                        "^Intermediate_monocytes$" = "Monocytes",
                        "^Macrophage_monocyte_derived$" = "Macrophages",
                        "^MAI_Tcells$" = "T_cells",
                        "^Memory_Bcells$" = "B_cells",
                        "^Monocyte_CD16_plus$" = "Monocytes",
                        "^Monocyte_leukotriene_D4$" = "Monocytes",
                        "^Monocytes_CD16_minus$" = "Monocytes",
                        "^Naive_Bcells$" = "B_cells",
                        "^Naive_CD8T$" = "T_cells",
                        "^Plasmablasts_Bcells$" = "B_cells",
                        "^Alveolar_fibroblasts$" = "Fibroblasts",
                        "^Alveolar_macrophages$" = "Macrophages",
                        "^AlvEpithelial_T1$" = "Epithelial_cells",
                        "^AlvEpithelial_T2$" = "Epithelial_cells",
                        "^CD4T_cells$" = "T_cells",
                        "^CD8T_cells$" = "T_cells",
                        "^Dendritic_cells1$" = "Dendritic_cells",
                        "^Dendritic_cells2$" = "Dendritic_cells",
                        "^EC_artery$" = "Endothelial_cells",
                        "^EC_capillary$" = "Endothelial_cells",
                        "^EC_vein$" = "Endothelial_cells",
                        "^EC_lymphatic$" = "Endothelial_cells",
                        "^Interstitial_macrophage$" = "Macrophages",
                        "^Interstitial_macrophages$" = "Macrophages",
                        "^Peribronchial_fibroblasts$" = "Fibroblasts",
                        "^SM_activated_stress_response$" = "Smooth_muscle",
                        "^Subpleural_fibroblasts$" = "Fibroblasts",
                        "^Transitional_Club_AT2$" = "Epithelial_cells",
                        "^Tuft$" = "Epithelial_cells",
                        "^Proliferating_NK$" = "NK_cells",
                        "^Tgd_cells$" = "T_cells",
                        "^AlvEpithelial_cells$" = "Epithelial_cells",
                        "^Club_cells$" = "Epithelial_cells",
                        "^EC_aerocyte_capillary$" = "Endothelial_cells",
                        "^Migratory_DCs$" = "Dendritic_cells"))

        s_obj$Ann_level1 <-
            stringr::str_replace_all(s_obj$Ann_level2,
                        c("^B_cells$" = "Immune_Lymphoid",
                        "^Dendritic_cells$" = "Immune_Myeloid",
                        "^Erythrocytes$" = "Immune_Myeloid",
                        "^Macrophages$" = "Immune_Myeloid",
                        "^Mast_cells$" = "Immune_Myeloid",
                        "^Monocytes$" = "Immune_Myeloid",
                        "^Neutrophils$" = "Immune_Myeloid",
                        "^NK_cells$" = "Immune_Lymphoid",
                        "^Fibroblasts$" = "Mesenchymal",
                        "^Stromal_cells$" = "Mesenchymal",
                        "^T_cells$" = "Immune_Lymphoid",
                        "^Lymphocytes$" = "Immune_Lymphoid",
                        "^Pericytes$" = "Mesenchymal",
                        "^Basophils$" = "Immune_Myeloid",
                        "^Osteoblasts$" = "Mesenchymal",
                        "^Smooth_muscle$" = "Mesenchymal",
                        "^Cardiomyocytes$" = "Mesenchymal",
                        "^Adipocytes$" = "Mesenchymal",
                        "^Neurons$" = "Mesenchymal",
                        "^Granulocytes$" = "Immune_Myeloid",
                        "^Progenitors$" = "Immune_Myeloid",
                        "^Lymphoid_cells$" = "Immune_Lymphoid",
                        "^Mesothelial_cells$" = "Mesenchymal",
                        "^Mural_cells$" = "Mesenchymal"))

        dimplot1 <- 
            dimplot_better(s_obj,
                        group_by = "seurat_clusters") +
                NoLegend() +
                theme(plot.title = element_text(size = 7))


        dimplot2 <- 
            dimplot_better(s_obj,
                        group_by = "new_annot_clust") +
                NoLegend() +
                theme(plot.title = element_text(size = 7))

        dimplot3 <- 
            dimplot_better(s_obj,
                        group_by = "sample_name") +
                NoLegend() +
                theme(plot.title = element_text(size = 7))

        dimplot4 <- 
            dimplot_better(s_obj,
                        group_by = "data_source") +
                NoLegend() +
                theme(plot.title = element_text(size = 7))

        all_dimplots <- 
            patchwork::wrap_plots(dimplot1,
                                  dimplot2,
                                  dimplot3,
                                  dimplot4,
                                  ncol = 2,
                                  widths = 14,
                                  heights = 14) +
            patchwork::plot_annotation(title = str_c(group, " ", cell_group_name)) +
            theme(plot.title = element_text(size = 10))

        ggsave(str_c("output/figures/tumor_vs_stroma/",
                    group,
                    "/",
                    cell_group_name,
                    "_dimplot.png"),
                plot = all_dimplots,
                width = 14,
                height = 14)

        #save as qs
        qs::qsave(all_dimplots,
                  str_c("output/figures/tumor_vs_stroma/",
                        group,
                        "/",
                        cell_group_name,
                        "_dimplot.qs"))

        if (object$organism[1] == "human") {
            tumor_featureplot <- 
                FeaturePlot(s_obj,
                            features = c("COL1A1", "COL1A2", "FBLN1",
                                        "SATB2", "RUNX2", "SOX9"),
                            ncol = 3)
            immune_featureplot <- 
                FeaturePlot(s_obj,
                            features = c("CD3E", "CD4", "CD68",
                                        "MUC1", "MS4A1", "ESAM"),
                            ncol = 3)
        } else {
            tumor_featureplot <- 
                FeaturePlot(s_obj,
                            features = c("Col1a1", "Col1a2", "Fbln1",
                                        "Satb2", "Runx2", "Sox9"),
                            ncol = 3)
            immune_featureplot <-
                FeaturePlot(s_obj,
                            features = c("Cd3e", "Cd4", "Cd68",
                                        "Muc1", "Ms4a1", "Esam"),
                            ncol = 3)
        }
            ggsave(str_c("output/figures/tumor_vs_stroma/",
                        group,
                        "/",
                        cell_group_name,
                        "_tumor_featureplot.png"),
                    plot = tumor_featureplot,
                    width = 21,
                    height = 21)

        #save as qs
        qs::qsave(tumor_featureplot,
                  str_c("output/figures/tumor_vs_stroma/",
                        group,
                        "/",
                        cell_group_name,
                        "_tumor_featureplot.qs"))

        ggsave(str_c("output/figures/tumor_vs_stroma/",
                    group,
                    "/",
                    cell_group_name,
                    "_immune_featureplot.png"),
                plot = immune_featureplot,
                width = 21,
                height = 21)
        
        #save as qs
        qs::qsave(immune_featureplot,
                  str_c("output/figures/tumor_vs_stroma/",
                        group,
                        "/",
                        cell_group_name,
                        "_immune_featureplot.qs"))

        qs::qsave(s_obj, str_c("output/seurat_objects/tumor_vs_stroma/",  #nolint
                                group, "_",
                                cell_group_name,
                                ".qs"))
    }
    print(str_c(group, " labelled with cancer_vs_normal cells and subsetted and saved"))
}

#save the xenograft objects
for (group in c("xeno_prim_human",
                "xeno_prim_mouse",
                "xeno_mets_human",
                "xeno_mets_mouse")) {
    object <-
        qs::qread(str_c("output/seurat_objects/harmony_sobjs_annot/",
                        group,
                        ".qs"))
    object$Ann_level3 <-
        stringr::str_replace_all(object$annotations,
                    c("^DC__DC_$" = "Dendritic_cells",
                    "^DC__DC_103_11B_plus24_plus_$" = "Dendritic_cells",
                    "^DC__DC_PDC_8_plus_$" = "Plasmacytoid_Dendritic",
                    "^DC__DC_8_4_11B_plus_$" = "Dendritic_cells",
                    "^B_cell_Plasma_cell$" = "Plasma_Bcells",
                    "^Macrophages__MF_103_11B_plus24__$" = "Macrophages",
                    "^Macrophages__MF_11C_11B_plus_$" = "Macrophages",
                    "^DC_monocyte_derived_AEC_conditioned$" = "DC_monocyte_derived",
                    "^Mast_cells__MC.ES_$" = "Mast_cells",
                    "^Neutrophils__GN.Thio_$" = "Neutrophils",
                    "^Stromal_cells__ST.31_38_44__$" = "Stromal_cells",
                    "^T_cells__T.Tregs_$" = "Regulatory_T",
                    "^CD4_plus_T$" = "CD4T_cells",
                    "^CD8_plus_T$" = "CD8T_cells",
                    "^Capillary_Aerocyte$" = "EC_capillary_aerocyte",
                    "^Capillary$" = "EC_capillary",
                    "^Lympatic$" = "EC_Lympatic",
                    "^Myeloid_Dendritic_Type_1$" = "Myeloid_Dendritic",
                    "^Myofibroblast$" = "Myofibroblasts",
                    "^Natural_Killer$" = "NK_cells",
                    "^Plasma$" = "Plasma_Bcells",
                    "^B_cell_Plasma_cell$" = "Plasma_Bcells",
                    "^B$" = "B_cells",
                    "^Ciliated$" = "Ciliated_cells",
                    "^DC_monocyte_derived_AEC_conditioned$" = "DC_monocyte_derived",
                    "^DC_monocyte_derived_antiCD40_VAF347$" = "DC_monocyte_derived",
                    "^DC_monocyte_derived_mature$" = "DC_monocyte_derived",
                    "^Effector memory CD8 T cells$" = "Effector_memory_CD8T",
                    "^Endothelial_cells_blood_vessel" = "EC_blood_vessel",
                    "^Endothelial_cells_HUVEC_VEGF$" = "EC_HUVEC_VEGF",
                    "^Endothelial_cells_lymphatic$" = "EC_lymphatic",
                    "^Endothelial_cells_lymphatic_KSHV$" = "EC_lymphatic",
                    "^Fibroblasts_breast$" = "Fibroblasts",
                    "^Intermediate monocytes$" = "Intermediate_monocytes",
                    "^Low-density basophils$" = "Basophils",
                    "^Low-density neutrophils$" = "Neutrophils",
                    "^Macrophage_monocyte_derived_IL_4_Dex_TGFb$" = "Macrophage_monocyte_derived",
                    "^Macrophage_monocyte_derived_M_CSF$" = "Macrophage_monocyte_derived",
                    "^MAIT cells$" = "MAI_Tcells",
                    "^Monocyte_CD16_$" = "Monocytes_CD16_minus",
                    "^Monocyte_S._typhimurium_flagellin$" = "Monocytes",
                    "^Neutrophil_commensal_E._coli_MG1655$" = "Neutrophils",
                    "^Myeloid dendritic cells$" = "Myeloid_Dendritic",
                    "^Naive B cells$" = "Naive_Bcells",
                    "^Naive CD8 T cells$" = "Naive_CD8T",
                    "^NK_cell$" = "NK_cells",
                    "^Plasmablasts$" = "Plasmablasts_Bcells",
                    "^Plasmacytoid dendritic cells$" = "Plasmacytoid_Dendritic",
                    "^Switched memory B cells$" = "Memory_Bcells",
                    "^T regulatory cells$" = "Regulatory_T",
                    "^T_cell_CD4_plus_central_memory$" = "Central_memory_CD4T",
                    "^T_cell_CD4_plus_effector_memory$" = "Effector_memory_CD4T",
                    "^T_cell_CD4_plus_Naive$" = "Naive_CD4T",
                    "^T_cell_CD8_plus_Central_memory$" = "Central_memory_CD8T",
                    "^T_cell_CD8_plus_naive$" = "Naive_CD8T",
                    "^T_cell_gamma_delta$" = "GammaDelta_Tcells",
                    "^AT1$" = "AlvEpithelial_T1",
                    "^AT2$" = "AlvEpithelial_T2",
                    "^CD4_T_cells$" = "CD4T_cells",
                    "^CD8_T_cells$" = "CD8T_cells",
                    "^DC1$" = "Dendritic_cells1",
                    "^DC2$" = "Dendritic_cells2",
                    "^EC_arterial$" = "EC_artery",
                    "^EC_general_capillary$" = "EC_capillary",
                    "^EC_venous_pulmonary$" = "EC_vein",
                    "^EC_venous_systemic$" = "EC_vein",
                    "^Lymphatic_EC_mature$" = "EC_lymphatic",
                    "^Multiciliated$" = "Ciliated_cells",
                    "^Non_classical_monocytes$" = "Nonclassical_monocytes",
                    "^Nonclassical_Monocyte$" = "Nonclassical_monocytes",
                    "^Classical_Monocyte$" = "Classical_monocytes",
                    "^Plasma_cells$" = "Plasma_Bcells",
                    "^Plasmacytoid_DCs$" = "Plasmacytoid_Dendritic",
                    "^T_cells_proliferating$" = "Proliferating_T",
                    "^Neutrophil$" = "Neutrophils",
                    "^Pericyte$" = "Pericytes",
                    "^Astrocytes$" = "Neurons",
                    "^Stem_cells$" = "Progenitors",
                    "^Basophil_Mast" = "Basophils",
                    "^Capillary_cells$" = "EC_capillary",
                    "^Artery_cells$" = "EC_artery",
                    "^Vein_cells$" = "EC_vein",
                    "^Lymph_cells$" = "EC_lymphatic",
                    "^Alv_Macrophages$" = "Alveolar_macrophages",
                    "^Int_Macrophages$" = "Interstitial_macrophage",
                    "^Myo_Fibroblasts$" = "Myofibroblasts",
                    "^Monocyte_leukotriene_D4$" = "Monocytes",
                    "^Oligodendrocytes$" = "Stromal_cells",
                    "^Transitional_Club_AT2$" = "Club_cells"))

        object$Ann_level2 <-
            stringr::str_replace_all(object$Ann_level3,
                    c("^Fibroblasts_activated$" = "Fibroblasts",
                        "^Fibroblasts_senescent$" = "Fibroblasts",
                        "^Macrophages_activated$" = "Macrophages",
                        "^Plasmacytoid_Dendritic$" = "Dendritic_cells",
                        "^Regulatory_T$" = "T_cells",
                        "^Alox5_plus_Lymphocytes$" = "Lymphocytes",
                        "^Alveolar_Epithelial$" = "Epithelial_cells",
                        "^Alveolar_Fibroblast$" = "Fibroblasts",
                        "^Alveolar_Macrophage$" = "Macrophages",
                        "^Ccr7_plus_Dendritic$" = "Dendritic_cells",
                        "^Ciliated_cells$" = "Epithelial_cells",
                        "^Classical_monocytes" = "Monocytes",
                        "^EC_capillary$" = "Endothelial_cells",
                        "^EC_capillary_aerocyte$" = "Endothelial_cells",
                        "^EC_Lympatic$" = "Endothelial_cells",
                        "^Interstitial_Macrophage$" = "Macrophages",
                        "^Interstital_macrophage$" = "Macrophages",
                        "^Myeloid_Dendritic$" = "Dendritic_cells",
                        "^Myofibroblasts$" = "Fibroblasts",
                        "^Nonclassical_monocytes$" = "Monocytes",
                        "^Plasma_Bcells$" = "B_cells",
                        "^Proliferating_Alveolar_Macrophage" = "Macrophages",
                        "^Proliferating_T$" = "T_cells",
                        "^Proliferating_Dendritic$" = "Dendritic_cells",
                        "^Zbtb32_plus_B$" = "B_cells",
                        "^Central_memory_CD4T$" = "T_cells",
                        "^Central_memory_CD8T$" = "T_cells",
                        "^DC_monocyte_derived$" = "Dendritic_cells",
                        "^EC_blood_vessel$" = "Endothelial_cells",
                        "^EC_HUVEC_VEGF$" = "Endothelial_cells",
                        "^Effector_memory_CD4T$" = "T_cells",
                        "^Effector_memory_CD8T$" = "T_cells",
                        "^GammaDelta_Tcells$" = "T_cells",
                        "^Intermediate_monocytes$" = "Monocytes",
                        "^Macrophage_monocyte_derived$" = "Macrophages",
                        "^MAI_Tcells$" = "T_cells",
                        "^Memory_Bcells$" = "B_cells",
                        "^Monocyte_CD16_plus$" = "Monocytes",
                        "^Monocyte_leukotriene_D4$" = "Monocytes",
                        "^Monocytes_CD16_minus$" = "Monocytes",
                        "^Naive_Bcells$" = "B_cells",
                        "^Naive_CD8T$" = "T_cells",
                        "^Plasmablasts_Bcells$" = "B_cells",
                        "^Alveolar_fibroblasts$" = "Fibroblasts",
                        "^Alveolar_macrophages$" = "Macrophages",
                        "^AlvEpithelial_T1$" = "Epithelial_cells",
                        "^AlvEpithelial_T2$" = "Epithelial_cells",
                        "^CD4T_cells$" = "T_cells",
                        "^CD8T_cells$" = "T_cells",
                        "^Dendritic_cells1$" = "Dendritic_cells",
                        "^Dendritic_cells2$" = "Dendritic_cells",
                        "^EC_artery$" = "Endothelial_cells",
                        "^EC_capillary$" = "Endothelial_cells",
                        "^EC_vein$" = "Endothelial_cells",
                        "^EC_lymphatic$" = "Endothelial_cells",
                        "^Interstitial_macrophage$" = "Macrophages",
                        "^Peribronchial_fibroblasts$" = "Fibroblasts",
                        "^SM_activated_stress_response$" = "Smooth_muscle",
                        "^Subpleural_fibroblasts$" = "Fibroblasts",
                        "^Tuft$" = "Epithelial_cells",
                        "^Proliferating_NK$" = "NK_cells",
                        "^Tgd_cells$" = "T_cells",
                        "^AlvEpithelial_cells$" = "Epithelial_cells",
                        "^Club_cells$" = "Epithelial_cells"))

        object$Ann_level1 <-
            stringr::str_replace_all(object$Ann_level2,
                        c("^B_cells$" = "Immune_Lymphoid",
                        "^Dendritic_cells$" = "Immune_Myeloid",
                        "^Erythrocytes$" = "Immune_Myeloid",
                        "^Macrophages$" = "Immune_Myeloid",
                        "^Mast_cells$" = "Immune_Myeloid",
                        "^Monocytes$" = "Immune_Myeloid",
                        "^Neutrophils$" = "Immune_Myeloid",
                        "^NK_cells$" = "Immune_Lymphoid",
                        "^Fibroblasts$" = "Mesenchymal",
                        "^Stromal_cells$" = "Mesenchymal",
                        "^T_cells$" = "Immune_Lymphoid",
                        "^Lymphocytes$" = "Immune_Lymphoid",
                        "^Pericytes$" = "Mesenchymal",
                        "^Basophils$" = "Immune_Myeloid",
                        "^Osteoblasts$" = "Mesenchymal",
                        "^Smooth_muscle$" = "Mesenchymal",
                        "^Cardiomyocytes$" = "Mesenchymal",
                        "^Adipocytes$" = "Mesenchymal",
                        "^Neurons$" = "Mesenchymal",
                        "^Granulocytes$" = "Immune_Myeloid",
                        "^Progenitors$" = "Immune_Myeloid",
                        "^Lymphoid_cells$" = "Immune_Lymphoid",
                        "^Mesothelial_cells$" = "Mesenchymal",
                        "^Mural_cells$" = "Mesenchymal"))

    dimplot1 <- 
        dimplot_better(object,
                group_by = "seurat_clusters") +
            NoLegend() +
            theme(plot.title = element_text(size = 7))

    dimplot2 <-
        dimplot_better(object,
                    group_by = "new_annot_clust") +
            NoLegend() +
            theme(plot.title = element_text(size = 7))

    dimplot3 <- 
        dimplot_better(object,
                    group_by = "sample_name") +
            NoLegend() +
            theme(plot.title = element_text(size = 7))

    dimplot4 <- 
        dimplot_better(object,
                    group_by = "data_source") +
            NoLegend() +
            theme(plot.title = element_text(size = 7))

    all_dimplots <- 
        patchwork::wrap_plots(dimplot1,
                            dimplot2,
                            dimplot3,
                            dimplot4,
                            ncol = 2,
                            widths = 14,
                            heights = 14) +
        patchwork::plot_annotation(title = group,
                                   theme = theme(plot.title = element_text(size = 10)))
    
    ggsave(str_c("output/figures/tumor_vs_stroma/",
                group,
                "/",
                "dimplot.png"),
            plot = all_dimplots,
            width = 14,
            height = 14)
    
    # save as qs
    qs::qsave(all_dimplots,
              str_c("output/figures/tumor_vs_stroma/",
                    group,
                    "/",
                    "dimplot.qs"))

    if (object$organism[1] == "human") {
        tumor_featureplot <- 
            FeaturePlot(object,
                        features = c("COL1A1", "COL1A2", "FBLN1",
                                    "SATB2", "RUNX2", "SOX9"),
                        ncol = 3)
        immune_featureplot <- 
            FeaturePlot(object,
                        features = c("CD3E", "CD4", "CD68",
                                    "MUC1", "MS4A1", "ESAM"),
                        ncol = 3)
    } else {
        tumor_featureplot <- 
            FeaturePlot(object,
                        features = c("Col1a1", "Col1a2", "Fbln1",
                                    "Satb2", "Runx2", "Sox9"),
                        ncol = 3) 
        immune_featureplot <- 
            FeaturePlot(object,
                        features = c("Cd3e", "Cd4", "Cd68",
                                    "Muc1", "Ms4a1", "Esam"),
                        ncol = 3)
    }
    ggsave(str_c("output/figures/tumor_vs_stroma/",
                group,
                "/",
                "tumor_featureplot.png"),
            plot = tumor_featureplot,
            width = 21,
            height = 21)

    #save as qs
    qs::qsave(tumor_featureplot,
              str_c("output/figures/tumor_vs_stroma/",
                    group,
                    "/",
                    "tumor_featureplot.qs"))

    ggsave(str_c("output/figures/tumor_vs_stroma/",
                group,
                "/",
                "immune_featureplot.png"),
            plot = immune_featureplot,
            width = 21,
            height = 21)

    #save as qs
    qs::qsave(immune_featureplot,
              str_c("output/figures/tumor_vs_stroma/",
                    group,
                    "/",
                    "immune_featureplot.qs"))

    qs::qsave(object, str_c("output/seurat_objects/tumor_vs_stroma/",
                            group,
                            ".qs"))
}
```

