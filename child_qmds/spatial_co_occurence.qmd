## Cell Type Co-Occurrence

### Cell Type Correlation

The most simple way to address what cells are near each other is by using a simple correlation. For each sample I'll create a heatmap of correlations between cell types.

#### Ann_Level2

```{r}
spatial_list <- qs::qread("output/spatial_objects/spatial_list_level2_annotations.qs")
cell_types_2 <- unique(patient_mets$Ann_Level2)
pdf("output/figures/spatial/cooccurrence/level_2_heatmap.pdf")
for (ob in names(spatial_list)) {
    ann_matrix <- spatial_list[[ob]]@meta.data[ , cell_types_2]
    pheatmap::pheatmap(
        cor(ann_matrix),
        scale = "none",
        low = "blue",
        high = "red",
        mid = "white",
        midpoint = 0
    )
}
dev.off()

```

#### Ann_Level3
```{r cell-type-correlation}
spatial_list <- qs::qread("output/spatial_objects/spatial_list_level3_annotations.qs")
cell_types_3 <- unique(patient_mets$Ann_Level3)
pdf("output/figures/spatial/cooccurrence/level_3_heatmap.pdf")
for (ob in names(spatial_list)) {
    ann_matrix <- spatial_list[[ob]]@meta.data[ , cell_types_3]
    pheatmap::pheatmap(
        cor(ann_matrix),
        scale = "none",
        low = "blue",
        high = "red",
        mid = "white",
        midpoint = 0
    )
}
dev.off()
```

```{r}
#wanna look at correlation with tumor cells
for (ob in names(spatial_list)) {
    png(paste0("output/figures/spatial/cooccurrence/tumor_correlation_", ob, ".png"))

    p <- spatial_list[[ob]]@meta.data[ , c(cell_types, "Tumor_Cumulative")] %>%
        select(-c(Tumor_Proliferative,
                  Tumor_Metabolic,
                  Tumor_ImmuneRegulatory,
                  Tumor_Inflammatory,
                  Tumor_Ground)) %>%
        cor() %>%
        as.data.frame() %>%
        rownames_to_column("celltype1") %>%
        mutate(celltype1 = as.factor(celltype1) %>%
                    fct_reorder(Tumor_Cumulative)) %>%
        filter(celltype1 != "Tumor_Cumulative") %>%
        ggplot(aes(x = "", y = celltype1)) +
        geom_tile(aes(fill = Tumor_Cumulative)) +
        scale_fill_gradient2(low = "blue",
                         high = "red",
                         mid = "white",
                         midpoint = 0)
    print(p)
    dev.off()
    Sys.sleep(0.1)
}

cell_types <- unique(patient_mets$Ann_Level2)
### Create one single annotation matrix with scores from all objects, minus Tumor_Cumulative
ann_mat_list <- lapply(spatial_list, function(x) {
    x@meta.data[ , c(cell_types)]
})

#make one big matrix with deconvolution scores (for correlation purposes)
full_ann_matrix <- bind_rows(ann_mat_list)
png("output/figures/spatial/cooccurrence/all_sample_correlation.png", width = 900, height = 900)
pheatmap::pheatmap(cor(full_ann_matrix[, cell_types], method = "spearman"),
                   scale = "none",
                   low = "blue",
                   high = "red",
                   mid = "white",
                   midpoint = 0,
                   angle_col = 45,
                   fontsize = 16)
dev.off()

#make heatmaps for each sample
cell_type_heatmaps <- lapply(names(ann_mat_list), function(x) {
    p <- pheatmap::pheatmap(cor(ann_mat_list[[x]], method = "spearman"),
                       scale = "none",
                       low = "blue",
                       high = "red",
                       mid = "white",
                       midpoint = 0,
                       angle_col = 45,
                       fontsize = 16)
    png(paste0("output/figures/spatial/cooccurrence/cell_type_heatmap_", x, ".png"), width = 900, height = 900)
    print(p)
    dev.off()
    return(p)
})

# Make feature plots for cell types that correlate with each other
# epithelial and endothelial
plt_list <- lapply(names(spatial_list), function(x) {
    SpatialFeaturePlot(spatial_list[[x]],
                       features = c("Endothelial_cells", "Epithelial_cells"),
                       pt.size.factor = size.factors[[x]],
                       image.alpha = 0)
})

grid.arrange(grobs = plt_list, ncol = 2)


#see what cell types are most highly correlated with tumor subpopulations
tumor_types <- grep("Tumor", cell_types, value = TRUE)
for (feat in tumor_types) {
    #convert variable holding name of column to quosure
    feat_quo <- enquo(feat)

    p <- full_ann_matrix %>%
        dplyr::select(colnames(full_ann_matrix)[grep("Tumor",
                                                     colnames(full_ann_matrix),
                                                     invert = TRUE)],
                      feat) %>%
        cor() %>%
        as.data.frame() %>%
        rownames_to_column("celltype") %>%
        mutate(celltype = as.factor(celltype) %>%
            fct_reorder(.data[[feat]])) %>%
        filter(celltype != !!feat_quo) %>%
        ggplot(aes(x = "", y = celltype)) +
        geom_tile(aes(fill = .data[[feat_quo]])) +
        scale_fill_gradient2(low = "blue",
                             high = "red",
                             mid = "white",
                             midpoint = 0) +
        ggtitle(paste("Cell Type Correlation with", feat, "\n in the Same Spot"))
    png(paste0("output/figures/spatial/cooccurrence/cell_type_correlation_", feat, "_level2.png"))
    print(p)
    dev.off()
}
```