We are interested in how cell types and states in each sample change are evolving based on splicing dynamics. For this purpose will perform velocity analysis.

## New velocity analysis function

I realized that I should have just created individual loom files for the filtered_feature matrices, that way I can subset by any barcodes that I want. So i'm going to rewrite the r_make_loom_files function.

Input is a table with the following column names:
    -sample_id
    -h5_path
    -bam_path
    -species

```{r}
velo_input <- read.table("/home/gdrobertslab/lab/Analysis/Yogesh/CellTypeAnnRefs/misc/allsample_details.txt",
                         header = TRUE) %>%
    dplyr::select(sample_id = sample_name,
                  species,
                  data_source) %>%
    mutate(data_path = paste0(
            recode(data_source,
                   "GEO" = "/home/gdrobertslab/lab/Counts_2/",
                   "NCH" = "/home/gdrobertslab/lab/Counts_2/",
                   "SJ" = "/home/gdrobertslab/lab/ExternalData/Patel_lab/",
                   "NCI_POB" = "/home/gdrobertslab/lab/ExternalData/McEachron_lab/",
                   "CSU" = "/home/gdrobertslab/lab/ExternalData/Regan_lab/",
                   "TU" = "/home/gdrobertslab/lab/ExternalData/Gardner/",
                   "UoM" = "/home/gdrobertslab/lab/ExternalData/Modiano_Lab/Counts/"))) %>%
    unique() %>%
    mutate(#add h5 paths
           h5_path = ifelse(data_source == "NCI_POB",
                            paste0(data_path,
                                   "03_FilteredMatricesH5/",
                                   sample_id,
                                   "_filtered_feature_bc_matrix.h5"),
                            paste0(data_path,
                                   sample_id,
                                   "/filtered_feature_bc_matrix.h5")),
           #add bam paths
           bam_path = ifelse(data_source == "NCI_POB",
                             paste0(data_path,
                                    "BAMs/",
                                    sample_id,
                                    "_gex_possorted_bam.bam"),
                             ifelse(data_source == "CSU",
                                    paste0(data_path,
                                           sample_id,
                                           "/",
                                           sample_id,
                                           "_possorted_genome_bam.bam"),
                                    paste0(data_path,
                                           sample_id,
                                           "/possorted_genome_bam.bam"))),
           gtf_path = recode(species,
                             "canine" = "/home/gdrobertslab/lab/GenRef/10x-canine-atlas_arc/genes/genes.gtf.gz",
                             "mousemodel" = "/home/gdrobertslab/lab/GenRef/10x-mm10_arc/genes/genes.gtf.gz",
                             "patient" = "/home/gdrobertslab/lab/GenRef/10x-hg38_arc/genes/genes.gtf.gz",
                             "xenograft" = "/home/gdrobertslab/lab/GenRef/10x-hg38-mm10_arc/genes/genes.gtf.gz"))
#fix edge cases for h5's (subset of dan regan's objects) and bams (subset of nch ones)
velo_input$h5_path[!file.exists(velo_input$h5_path)] <-
    paste0(velo_input$data_path,
          velo_input$sample_id,
          "/",
          velo_input$sample_id,
          "_filtered_feature_bc_matrix.h5")[!file.exists(velo_input$h5_path)]
velo_input$bam_path[!file.exists(velo_input$bam_path)] <-
    paste0(velo_input$data_path,
           velo_input$sample_id,
           "/gex_possorted_bam.bam")[!file.exists(velo_input$bam_path)]

all(file.exists(velo_input$h5_path) & file.exists(velo_input$bam_path))

rownames(velo_input) <- NULL

loom_paths <- paste0("loom_output/samples/", velo_input$sample_id, "/", velo_input$sample_id, ".loom")
loom_paths[!file.exists(loom_paths)]

velo_input <- velo_input[!file.exists(loom_paths), ]

r_make_loom_files(input_table = velo_input,
                  out_dir = "loom_output/samples",
                  cluster_account = "gdrobertslab")
```

## Write off Metadata for Velocity Analysis

In order to analyze the data, we need to save a table of cell-level metadata, including barcodes, seurat clusters, and annotations.

First we need to read in our objects for this. I'm using the objects from final_tumor_vs_stroma

```{r}
yogi_prefix <- "/home/gdrobertslab/lab/Analysis/Yogesh/CellTypeAnnRefs/"
obj_names <- list.files(paste0(yogi_prefix, "output/seurat_objects/final_tumor_vs_stroma"))
#get only fdl files
obj_names <- str_replace_all(obj_names,
                             ".qs",
                             "")

obj_list <- list()
for (ob_name in obj_names) {
    obj_list[[ob_name]] <-
        qs::qread(paste0("/home/gdrobertslab/lab/Analysis/Yogesh/CellTypeAnnRefs/output/seurat_objects/final_tumor_vs_stroma/", ob_name, ".qs"))
}


#run fdl
parallel::detectCores()
obj_list_fdl <- parallel::mclapply(obj_list, FUN = run_fdl, mc.cores = (parallel::detectCores() - 8))

qs::qsave(obj_list_fdl, "output/seurat_objects/obj_list_04_04_2025.qs")
```

```{r write-off-md}
lapply(names(obj_list_fdl), function(obj_name) {
    write_off_md(sobj = obj_list_fdl[[obj_name]],
                 id_col = "sample_name",
                 output_dir = paste0("loom_output/metadata/",
                                     obj_name),
                 vars_to_keep = c("sample_name",
                                  "seurat_clusters",
                                  "Ann_Level1",
                                  "Ann_Level2",
                                  "Ann_Level3"),
                 handle_n_of_1 = FALSE)
})
```

### Write off Metadata for snRNA vs scRNA

I need to do this in order to check how consistent the single nuclei data's velocity estimates are with the single cell data's, since the tool was developed initially for single-cell. In order to not let this get out of hand, I'm going to write off this metadata into a directory in `loom_output/metadata/sn_vs_sc`. Similarly, I'm only going to do this for the objects strictly cancer objects.

```{r}
ob_names <- c(
    "patient_mets_cancer_cells",
    "patient_prim_cancer_cells",
    "mm_mets_cancer_cells",
    "mm_prim_cancer_cells",
    "dogs_mets_cancer_cells",
    "dogs_prim_cancer_cells"
)

split_ob_list <- list()
for (ob in ob_names) {
    split_ob_list[[ob]] <- qs::qread(
        paste0(
            yogi_prefix,
            "output/seurat_objects/final_tumor_vs_stroma/",
            ob,
            ".qs"
        )
    )
}

# make metadata dir
dir.create("loom_output/split_metadata/sn/", recursive = TRUE)
dir.create("loom_output/split_metadata/sc/", recursive = TRUE)
# now split objects and write metadata
for (ob in ob_names) {
    num_sn <- sum(split_ob_list[[ob]]$method == "single_nucleus")
    num_sc <- sum(split_ob_list[[ob]]$method == "single_cell")

    if (num_sn > 0) {
        subset(split_ob_list[[ob]],
            method == "single_nucleus") %>%
            write_off_md(id_col = "sample_name",
                    output_dir = paste0("loom_output/split_metadata/sn/",
                                        ob),
                    vars_to_keep = c("sample_name",
                                    "seurat_clusters",
                                    "Ann_Level1",
                                    "Ann_Level2",
                                    "Ann_Level3",
                                    "method"),
                    handle_n_of_1 = FALSE)
    }
    
    if (num_sc > 0) {
        subset(split_ob_list[[ob]],
           method == "single_cell") %>%
        write_off_md(
            id_col = "sample_name",
            output_dir = paste0("loom_output/split_metadata/sc/", ob),
            vars_to_keep = c("sample_name",
                            "seurat_clusters",
                            "Ann_Level1",
                            "Ann_Level2",
                            "Ann_Level3",
                            "method"),
            handle_n_of_1 = FALSE
        )
    }
}
```

## Analyze .loom Files

First I need to activate my conda environment. I set `eval = FALSE` because the environment path will change based on who is rendering this file.

```{bash activate-env, eval = FALSE}
conda activate /home/gdrobertslab/mjg015/R/x86_64-pc-linux-gnu-library/4.3/rrrSingleCellUtils/r_rna_velo
```

Next I need to import my conda libraries.

```{python load-py-libs}
import anndata
import scvelo as scv
import pandas as pd
import numpy as np
import matplotlib as plt
import igraph
plt.use('Agg')
from matplotlib import pyplot
from matplotlib.colors import ListedColormap
import scanpy as sc
import os
import re
```

### Make Objects and Plots

```{python analyze-mm-mets-cancer-cells}
#get names of loom files
ob_names = os.listdir("loom_output/metadata")
ob_names = list(filter(lambda x:"dog" not in x, ob_names))

for ob in ob_names:
    write_ob_and_plots(ob)

def write_ob_and_plots(ob):
    print("starting on " + ob)
    merged_ad=loom_to_an(obj_name = ob,
                     loom_dir = "loom_output/samples",
                     metadata_dir = "loom_output/metadata")
    print("made " + ob + " , now calculating velocity")
    calc_velo(merged_ad)
    merged_ad.write(filename = "loom_output/anndata/" + ob + ".ad")
    print("calculated velocity and saved off " + ob)
    # merged_ad = anndata.read("loom_output/anndata/" + ob + ".ad")
    # #make the plots and save them off
    # #seurat clusters in umap space
    # scv.pl.velocity_embedding_stream(merged_ad,
    #                                  basis = "umap",
    #                                  color = "seurat_clusters",
    #                                  show = False,
    #                                  sort_order = False)
    # pyplot.savefig("figures/scvelo/" + ob + "_umap_clusters.pdf")
    # #Ann_Level3 in umap space
    # scv.pl.velocity_embedding_stream(merged_ad,
    #                                  basis = "umap",
    #                                  color = "Ann_Level3",
    #                                  show = False,
    #                                  sort_order = False)
    # pyplot.savefig("figures/scvelo/" + ob + "_umap_annotations.pdf")
    # #seurat_clusters in fdl
    # scv.pl.velocity_embedding_stream(merged_ad,
    #                                  basis = "fdl",
    #                                  color = "seurat_clusters",
    #                                  show = False,
    #                                  sort_order = False)
    # pyplot.savefig("figures/scvelo/" + ob + "_fdl_clusters.pdf")
    # #cell types in fdl
    # scv.pl.velocity_embedding_stream(merged_ad,
    #                                  basis = "fdl",
    #                                  color = "Ann_Level3",
    #                                  show = False,
    #                                  sort_order = False)
    # pyplot.savefig("figures/scvelo/" + ob + "_fdl_annotations.pdf")
    # return(ob + " is done")


```

#### Remaking Tumor Plots with Lab Colors

I'm remaking the velocity stream plots for the tumor objects with 2 changes:
    1. Removing "Tumor_" from the cell type annotations
    2. Using the lab colors for coloring the clusters so we are consistent across Seurat and scv

```{python}
color_mapping = {"Synthetic": "#D43F3A",
                 "Fibrogenic": "#EEA236",
                 "Progenitor": "#357EBD",
                 "Proliferative": "#5CB85C",
                 "Interactive": "#B8B8B8",
                 "Apoptosis": "#9632B8"}

hex_codes = ["#D43F3AFF", "#EEA236FF", "#357EBDFF", "#5CB85CFF", "#B8B8B8FF", "#9632B8FF", "#46B8DAFF", "#90302DFF", "#A66D04FF", "#2D577FFF", "#3E7E3EFF", "#7D7D7DFF", "#6D1D87FF", "#097F9AFF", "#FF6E6AFF", "#FFBB70FF", "#68A4E3FF", "#79D379FF", "#CDCDCDFF", "#BF6BE2FF", "#69D1F3FF", "#00FF00", "#00FFFF", "#FF00FF", "#0000FF", "#FFFF00", "#FF0000"]

ob_names = os.listdir("loom_output/anndata")

for ob in ob_names:
    ad_ob = anndata.read("loom_output/anndata/" + ob)
    #remove .ad from ob
    ob = ob.replace(".ad", "")
    scv.pl.velocity_embedding_stream(ad_ob,
                                     basis = "umap",
                                     color = "seurat_clusters",
                                     show = False,
                                     palette = hex_codes,
                                     sort_order = False,
                                     figsize = (7, 7),
                                     legend_loc = "none")
    pyplot.savefig("figures/scvelo/yogesh_04_29_25/" + ob + "_umap_clusters.svg")
    #seurat_clusters in fdl
    scv.pl.velocity_embedding_stream(ad_ob,
                                     basis = "fdl",
                                     color = "seurat_clusters",
                                     palette = hex_codes,
                                     show = False,
                                     sort_order = False,
                                     figsize = (7, 7),
                                     legend_loc = "none")
    pyplot.savefig("figures/scvelo/yogesh_04_29_25/" + ob + "_fdl_clusters.svg")
    #Specify color dict for colors if cancer object
    if ob.find("cancer") != -1 or ob.find("_human") != -1:
        #Strip Tumor_ from ann level 3
        ad_ob.obs["Ann_Level3"] = ad_ob.obs["Ann_Level3"].str.replace("Tumor_", "")
        #Ann_Level3 in umap space
        scv.pl.velocity_embedding_stream(ad_ob,
                                         basis = "umap",
                                         color = "Ann_Level3",
                                         palette = color_mapping,
                                         show = False,
                                         sort_order = False,
                                         figsize = (7, 7),
                                         legend_loc = "none")
        pyplot.savefig("figures/scvelo/yogesh_04_29_25/" + ob + "_umap_annotations.svg")
        #cell types in fdl
        scv.pl.velocity_embedding_stream(ad_ob,
                                         basis = "fdl",
                                         color = "Ann_Level3",
                                         palette = color_mapping,
                                         show = False,
                                         sort_order = False,
                                         figsize = (7, 7),
                                         legend_loc = "none")
        pyplot.savefig("figures/scvelo/yogesh_04_29_25/" + ob + "_fdl_annotations.svg")
    else:
        #Ann_Level3 in umap space
        scv.pl.velocity_embedding_stream(ad_ob,
                                         basis = "umap",
                                         color = "Ann_Level3",
                                         palette = hex_codes,
                                         show = False,
                                         sort_order = False,
                                         figsize = (7, 7),
                                         legend_loc = "none")
        pyplot.savefig("figures/scvelo/yogesh_04_29_25/" + ob + "_umap_annotations.svg")
        #cell types in fdl
        scv.pl.velocity_embedding_stream(ad_ob,
                                         basis = "fdl",
                                         color = "Ann_Level3",
                                         palette = hex_codes,
                                         show = False,
                                         sort_order = False,
                                         figsize = (7, 7),
                                         legend_loc = "none")
        pyplot.savefig("figures/scvelo/yogesh_04_29_25/" + ob + "_fdl_annotations.svg")

```

### Make Objects and Plots for Single Cell and Single Nucleus

```{python}
sc_obs = os.listdir("loom_output/split_metadata/sc/")
sn_obs = os.listdir("loom_output/split_metadata/sn/")
os.makedirs("loom_output/split_ad/sc")
os.makedirs("loom_output/split_ad/sn")
os.makedirs("figures/scvelo/split_methods/sc")
os.makedirs("figures/scvelo/split_methods/sn")

for snob in sn_obs:
    write_ob_and_plots(ob = snob, method = "sn")

for scob in sc_obs:
    write_ob_and_plots(ob = scob, method = "sc")


def write_ob_and_plots(ob, method):
    print("starting on " + ob)
    merged_ad=loom_to_an(obj_name = ob,
                     loom_dir = "loom_output/samples",
                     metadata_dir = "loom_output/split_metadata/" + method)
    print("made " + ob + " , now calculating velocity")
    calc_velo(merged_ad)
    merged_ad.write(filename = "loom_output/split_ad/" + method + "/" + ob + ".ad")
    print("calculated velocity and saved off " + ob + " for " + method)
    #Now start making plots
    scv.pl.velocity_embedding_stream(merged_ad,
                                     basis = "umap",
                                     color = "seurat_clusters",
                                     show = False,
                                     palette = hex_codes,
                                     sort_order = False,
                                     figsize = (7, 7),
                                     legend_loc = "none")
    pyplot.savefig("figures/scvelo/split_methods/" + method + "/" + ob + "_umap_clusters.svg")
    #seurat_clusters in fdl
    scv.pl.velocity_embedding_stream(merged_ad,
                                     basis = "fdl",
                                     color = "seurat_clusters",
                                     palette = hex_codes,
                                     show = False,
                                     sort_order = False,
                                     figsize = (7, 7),
                                     legend_loc = "none")
    pyplot.savefig("figures/scvelo/split_methods/" + method + "/" + ob + "_fdl_clusters.svg")
    #Now plot cell types
    scv.pl.velocity_embedding_stream(ad_ob,
                                     basis = "umap",
                                     color = "Ann_Level3",
                                     palette = color_mapping,
                                     show = False,
                                     sort_order = False,
                                     figsize = (7, 7),
                                     legend_loc = "none")
    pyplot.savefig("figures/scvelo/split_methods/" + method + "/" + ob + "_umap_annotations.svg")
    #cell types in fdl
    scv.pl.velocity_embedding_stream(ad_ob,
                                     basis = "fdl",
                                     color = "Ann_Level3",
                                     palette = color_mapping,
                                     show = False,
                                     sort_order = False,
                                     figsize = (7, 7),
                                     legend_loc = "none")
    pyplot.savefig("figures/scvelo/split_methods/" + method + "/" + ob + "_fdl_annotations.svg")


```

### Get Top Velocity Genes for Each Cluster/Cell Type

I'll only be doing this for cancer objects

```{python}
ob_names = list(filter(lambda x:"cancer" in x, ob_names))
ob_names = list(filter(lambda x:"dogs_mets_cancer_cells" != x, ob_names))

velo_gene_list = dict()
ob_list = dict()
for ob in ob_names:
    tmp = anndata.read("loom_output/anndata/" + ob + ".ad")
    ob_list[ob] = tmp
    scv.tl.rank_velocity_genes(tmp, groupby = "Ann_Level3", min_corr = 0.3)
    rank_genes = tmp.uns["rank_velocity_genes"]
    df = pd.DataFrame(tmp.uns["rank_velocity_genes"]["names"])
    velo_gene_list[ob] = df
    df.to_csv("loom_output/velocity_genes/" + ob + ".csv", index = False)

#evaluate speed and confidence of velocity estimates
for ob in ob_names:
    tmp = ob_list[ob]
    scv.tl.velocity_confidence(tmp)
    ob_list[ob] = tmp

keys = "velocity_length", "velocity_confidence"
scv.pl.scatter(ob_list["patient_mets_cancer_cells"], c = keys, perc = [5, 95], basis = "umap", cmap = "coolwarm")

#we'll use paga to investigate the velocity trajectories
for ob in ob_names:
    tmp = ob_list[ob]
    tmp.uns['neighbors']['distances'] = tmp.obsp['distances']
    tmp.uns['neighbors']['connectivities'] = tmp.obsp['connectivities']
    scv.tl.paga(tmp, groups='Ann_Level3')
    ob_list[ob] = tmp

#save object dict
with open("output/python_objects/cancer_ad_list.pkl", "wb") as file:
    pickle.dump(ob_list, file)

tmp = ob_list["patient_mets_cancer_cells"]

keys = ['velocity_length', 'velocity_confidence']
df = tmp.obs.groupby('Ann_Level3')[keys].mean().T
df.style.background_gradient(cmap='coolwarm', axis=1)


df = scv.get_df(tmp, 'paga/transitions_confidence', precision=2).T
df.style.background_gradient(cmap='Blues').format('{:.2g}')

scv.pl.paga(tmp, basis='fdl', size=50, alpha=.1,
            min_edge_width=2, node_size_scale=1.5)
pyplot.savefig("tmp.png")
```

Let's look at these genes as modules in our single cell data.

```{r}
tmp <- obj_list_fdl[["patient_mets_cancer_cells"]]
tmp_velo_genes <-
    read.table("loom_output/velocity_genes/patient_mets_cancer_cells_clusters.csv",
               sep = ",",
               header = TRUE)

tmp <- AddModuleScore(tmp,
                      features = as.list(tmp_velo_genes),
                      name = colnames(tmp_velo_genes))

FeaturePlot(tmp,
            features = paste0(colnames(tmp_velo_genes), 1:12),
            raster = FALSE,
            cols = rev(brewer.pal(n = 11, name = "RdBu")),
            ncol = 6) / r_dim_plot(tmp, group.by = "seurat_clusters", raster = FALSE)
```